"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ScrollScene = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _scrollmagicWithSsr = _interopRequireDefault(require("./scrollmagic-with-ssr"));

var _lodash = _interopRequireDefault(require("lodash.throttle"));

var _helpers = require("./helpers");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var nameSpace = 'ScrollScene';

var updateTweenProgress = function updateTweenProgress(Scene, Tween, gsapForwardSpeed, gsapReverseSpeed) {
  if (Tween) {
    var progress = Scene.progress();
    var state = Scene.state();

    if (Tween.repeat && Tween.repeat() === -1) {
      if (state === 'DURING' && Tween.paused()) {
        Tween.timeScale(gsapForwardSpeed).play();
      } else if (state !== 'DURING' && !Tween.paused()) {
        Tween.pause();
      }
    } else if (progress != Tween.progress()) {
      if (Scene.duration() === 0) {
        if (progress > 0) {
          Tween.timeScale(gsapForwardSpeed).play();
        } else {
          Tween.timeScale(gsapReverseSpeed).reverse();
        }
      } else {
        Tween.progress(progress).pause();
      }
    }
  }
};

var removeTween = function removeTween(Tween) {
  if (Tween) {
    Tween.pause(0);
    Tween.kill();
  }
};

var setDuration = function setDuration(Scene, duration) {
  if ((0, _helpers.isObject)(duration)) {
    var keys = Object.keys(duration).reverse();

    var fn = function fn() {
      for (var index = 0; index < keys.length; index++) {
        var breakpoint = parseFloat(keys[index]);

        if (breakpoint <= window.innerWidth) {
          Scene.duration(duration[breakpoint]);
          break;
        }
      }
    };

    fn();
    window.addEventListener('resize', (0, _lodash["default"])(fn, 700));
  } else {
    Scene.duration(duration);
  }
};

var setClassName = function setClassName(Scene, options, duration) {
  var toggle = _objectSpread({
    className: null,
    element: null,
    reverse: false
  }, options);

  if (!toggle.className) {
    (0, _helpers.errorLog)(nameSpace, "Be sure to set a className in the new ".concat(nameSpace, "({ toggle: { className: \"my-class\" } })"));
  }

  if (!toggle.element) {
    (0, _helpers.errorLog)(nameSpace, "Be sure to set a const toggleElement = (reactRef.current or document.querySelector) in the new ".concat(nameSpace, "({ toggle: { element: toggleElement } })"));
  }

  var addClassName = function addClassName() {
    return !toggle.element.classList.contains(toggle.className) && toggle.element.classList.add(toggle.className);
  };

  var removeClassName = function removeClassName() {
    return toggle.element.classList.contains(toggle.className) && toggle.element.classList.remove(toggle.className);
  };

  Scene.on('enter', function () {
    addClassName();
  });
  Scene.on('add', function () {
    if (Scene.state() === 'DURING') {
      addClassName();
    }
  });
  Scene.on('leave', function (event) {
    if (!toggle.reverse && duration) {
      event.scrollDirection === 'REVERSE' && removeClassName();
    } else {
      removeClassName();
    }
  });
  Scene.on('remove', function () {
    removeClassName();
  });
};

var setTween = function setTween(Scene, options) {
  var gsap = _objectSpread({
    forwardSpeed: 1,
    reverseSpeed: 1,
    timeline: null
  }, options);

  if (!gsap.timeline) {
    (0, _helpers.errorLog)(nameSpace, "Be sure to set a const tl = gsap.timeline({ paused: true }) in the new ".concat(nameSpace, "({ gsap: { timeline: tl } })"));
  }

  Scene.on('progress', function () {
    updateTweenProgress(Scene, gsap.timeline, gsap.forwardSpeed, gsap.reverseSpeed);
  });
  Scene.on('remove', function () {
    removeTween(gsap.timeline);
  });
};

var globalController;

var ScrollScene = function ScrollScene(_ref) {
  var breakpoints = _ref.breakpoints,
      _ref$controller = _ref.controller,
      controller = _ref$controller === void 0 ? {} : _ref$controller,
      duration = _ref.duration,
      gsap = _ref.gsap,
      _ref$offset = _ref.offset,
      offset = _ref$offset === void 0 ? 0 : _ref$offset,
      _ref$scene = _ref.scene,
      scene = _ref$scene === void 0 ? {} : _ref$scene,
      toggle = _ref.toggle,
      triggerElement = _ref.triggerElement,
      _ref$triggerHook = _ref.triggerHook,
      triggerHook = _ref$triggerHook === void 0 ? 'onEnter' : _ref$triggerHook,
      _ref$useGlobalControl = _ref.useGlobalController,
      useGlobalController = _ref$useGlobalControl === void 0 ? true : _ref$useGlobalControl;
  var localController;

  if (!useGlobalController) {
    localController = new _scrollmagicWithSsr["default"].Controller(controller);
  }

  if (!globalController && useGlobalController) {
    globalController = new _scrollmagicWithSsr["default"].Controller(controller);
  }

  var controllerIsUse = localController ? localController : globalController;

  if (!triggerElement) {
    (0, _helpers.errorLog)(nameSpace, "Be sure to set a const triggerElement = (reactRef.current or document.querySelector) in the new ".concat(nameSpace, "({ triggerElement: triggerElement })"));
  }

  var Scene = new _scrollmagicWithSsr["default"].Scene(_objectSpread({
    triggerElement: triggerElement,
    triggerHook: triggerHook,
    offset: offset
  }, scene));

  if (duration) {
    setDuration(Scene, duration);
  }

  if (toggle && (0, _helpers.isObject)(toggle)) {
    setClassName(Scene, toggle, duration);
  }

  if (gsap && (0, _helpers.isObject)(gsap)) {
    setTween(Scene, gsap);
  }

  this.init = function () {
    controllerIsUse && Scene.addTo(controllerIsUse);
  };

  this.destroy = function () {
    Scene.remove();
  };

  this.Scene = Scene;
  this.Controller = controllerIsUse;
  (0, _helpers.scrollAnimationInit)(breakpoints, this.init, this.destroy);
};

exports.ScrollScene = ScrollScene;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TY3JvbGxTY2VuZS50cyJdLCJuYW1lcyI6WyJuYW1lU3BhY2UiLCJ1cGRhdGVUd2VlblByb2dyZXNzIiwiU2NlbmUiLCJUd2VlbiIsImdzYXBGb3J3YXJkU3BlZWQiLCJnc2FwUmV2ZXJzZVNwZWVkIiwicHJvZ3Jlc3MiLCJzdGF0ZSIsInJlcGVhdCIsInBhdXNlZCIsInRpbWVTY2FsZSIsInBsYXkiLCJwYXVzZSIsImR1cmF0aW9uIiwicmV2ZXJzZSIsInJlbW92ZVR3ZWVuIiwia2lsbCIsInNldER1cmF0aW9uIiwia2V5cyIsIk9iamVjdCIsImZuIiwiaW5kZXgiLCJsZW5ndGgiLCJicmVha3BvaW50IiwicGFyc2VGbG9hdCIsIndpbmRvdyIsImlubmVyV2lkdGgiLCJhZGRFdmVudExpc3RlbmVyIiwic2V0Q2xhc3NOYW1lIiwib3B0aW9ucyIsInRvZ2dsZSIsImNsYXNzTmFtZSIsImVsZW1lbnQiLCJhZGRDbGFzc05hbWUiLCJjbGFzc0xpc3QiLCJjb250YWlucyIsImFkZCIsInJlbW92ZUNsYXNzTmFtZSIsInJlbW92ZSIsIm9uIiwiZXZlbnQiLCJzY3JvbGxEaXJlY3Rpb24iLCJzZXRUd2VlbiIsImdzYXAiLCJmb3J3YXJkU3BlZWQiLCJyZXZlcnNlU3BlZWQiLCJ0aW1lbGluZSIsImdsb2JhbENvbnRyb2xsZXIiLCJTY3JvbGxTY2VuZSIsImJyZWFrcG9pbnRzIiwiY29udHJvbGxlciIsIm9mZnNldCIsInNjZW5lIiwidHJpZ2dlckVsZW1lbnQiLCJ0cmlnZ2VySG9vayIsInVzZUdsb2JhbENvbnRyb2xsZXIiLCJsb2NhbENvbnRyb2xsZXIiLCJTY3JvbGxNYWdpYyIsIkNvbnRyb2xsZXIiLCJjb250cm9sbGVySXNVc2UiLCJpbml0IiwiYWRkVG8iLCJkZXN0cm95Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7Ozs7QUFHQSxJQUFNQSxTQUFTLEdBQUcsYUFBbEI7O0FBRUEsSUFBTUMsbUJBQW1C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ZCxFQUFnQztBQUM5QkYsSUFBQUEsWUFBWSxDQUFDMUIsS0FBRCxFQUFRNEIsTUFBUixFQUFnQmpCLFFBQWhCLENBQVo7QUFDRDs7QUFFRCxNQUFJOEIsSUFBSSxJQUFJLHVCQUFTQSxJQUFULENBQVosRUFBNEI7QUFDMUJELElBQUFBLFFBQVEsQ0FBQ3hDLEtBQUQsRUFBUXlDLElBQVIsQ0FBUjtBQUNEOztBQUVELE9BQUtpQixJQUFMLEdBQVksWUFBVztBQUNyQkQsSUFBQUEsZUFBZSxJQUFJekQsS0FBSyxDQUFDMkQsS0FBTixDQUFZRixlQUFaLENBQW5CO0FBQ0QsR0FGRDs7QUFJQSxPQUFLRyxPQUFMLEdBQWUsWUFBVztBQUN4QjVELElBQUFBLEtBQUssQ0FBQ29DLE1BQU47QUFDRCxHQUZEOztBQUlBLE9BQUtwQyxLQUFMLEdBQWFBLEtBQWI7QUFDQSxPQUFLd0QsVUFBTCxHQUFrQkMsZUFBbEI7QUFFQSxvQ0FBb0JWLFdBQXBCLEVBQWlDLEtBQUtXLElBQXRDLEVBQTRDLEtBQUtFLE9BQWpEO0FBQ0QsQ0FuRUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2Nyb2xsTWFnaWMgZnJvbSAnLi9zY3JvbGxtYWdpYy13aXRoLXNzcidcbmltcG9ydCB0aHJvdHRsZSBmcm9tICdsb2Rhc2gudGhyb3R0bGUnXG5pbXBvcnQgeyBlcnJvckxvZywgaXNPYmplY3QsIHNjcm9sbEFuaW1hdGlvbkluaXQgfSBmcm9tICcuL2hlbHBlcnMnXG5pbXBvcnQgeyBJU2Nyb2xsT2JzZXJ2ZXJUb2dnbGUsIElTY3JvbGxPYnNlcnZlckdzYXAgfSBmcm9tICcuL1Njcm9sbE9ic2VydmVyJ1xuXG5jb25zdCBuYW1lU3BhY2UgPSAnU2Nyb2xsU2NlbmUnXG5cbmNvbnN0IHVwZGF0ZVR3ZWVuUHJvZ3Jlc3MgPSBmdW5jdGlvbihTY2VuZSwgVHdlZW4sIGdzYXBGb3J3YXJkU3BlZWQsIGdzYXBSZXZlcnNlU3BlZWQpIHtcbiAgaWYgKFR3ZWVuKSB7XG4gICAgY29uc3QgcHJvZ3Jlc3MgPSBTY2VuZS5wcm9ncmVzcygpXG4gICAgY29uc3Qgc3RhdGUgPSBTY2VuZS5zdGF0ZSgpXG4gICAgaWYgKFR3ZWVuLnJlcGVhdCAmJiBUd2Vlbi5yZXBlYXQoKSA9PT0gLTEpIHtcbiAgICAgIC8vIGluZmluaXRlIGxvb3AsIHNvIG5vdCBpbiByZWxhdGlvbiB0byBwcm9ncmVzc1xuICAgICAgaWYgKHN0YXRlID09PSAnRFVSSU5HJyAmJiBUd2Vlbi5wYXVzZWQoKSkge1xuICAgICAgICBUd2Vlbi50aW1lU2NhbGUoZ3NhcEZvcndhcmRTcGVlZCkucGxheSgpXG4gICAgICB9IGVsc2UgaWYgKHN0YXRlICE9PSAnRFVSSU5HJyAmJiAhVHdlZW4ucGF1c2VkKCkpIHtcbiAgICAgICAgVHdlZW4ucGF1c2UoKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocHJvZ3Jlc3MgIT0gVHdlZW4ucHJvZ3Jlc3MoKSkge1xuICAgICAgLy8gZG8gd2UgZXZlbiBuZWVkIHRvIHVwZGF0ZSB0aGUgcHJvZ3Jlc3M/XG4gICAgICAvLyBubyBpbmZpbml0ZSBsb29wIC0gc28gc2hvdWxkIHdlIGp1c3QgcGxheSBvciBnbyB0byBhIHNwZWNpZmljIHBvaW50IGluIHRpbWU/XG4gICAgICBpZiAoU2NlbmUuZHVyYXRpb24oKSA9PT0gMCkge1xuICAgICAgICAvLyBwbGF5IHRoZSBhbmltYXRpb25cbiAgICAgICAgaWYgKHByb2dyZXNzID4gMCkge1xuICAgICAgICAgIC8vIHBsYXkgZnJvbSAwIHRvIDFcbiAgICAgICAgICBUd2Vlbi50aW1lU2NhbGUoZ3NhcEZvcndhcmRTcGVlZCkucGxheSgpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gcGxheSBmcm9tIDEgdG8gMFxuICAgICAgICAgIFR3ZWVuLnRpbWVTY2FsZShnc2FwUmV2ZXJzZVNwZWVkKS5yZXZlcnNlKClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gZ28gdG8gYSBzcGVjaWZpYyBwb2ludCBpbiB0aW1lXG4gICAgICAgIC8vIGp1c3QgaGFyZCBzZXQgaXRcbiAgICAgICAgVHdlZW4ucHJvZ3Jlc3MocHJvZ3Jlc3MpLnBhdXNlKClcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuY29uc3QgcmVtb3ZlVHdlZW4gPSBmdW5jdGlvbihUd2Vlbikge1xuICBpZiAoVHdlZW4pIHtcbiAgICBUd2Vlbi5wYXVzZSgwKVxuICAgIFR3ZWVuLmtpbGwoKVxuICB9XG59XG5cbmNvbnN0IHNldER1cmF0aW9uID0gKFNjZW5lLCBkdXJhdGlvbikgPT4ge1xuICBpZiAoaXNPYmplY3QoZHVyYXRpb24pKSB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGR1cmF0aW9uKS5yZXZlcnNlKClcblxuICAgIGNvbnN0IGZuID0gKCkgPT4ge1xuICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGtleXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IGJyZWFrcG9pbnQgPSBwYXJzZUZsb2F0KGtleXNbaW5kZXhdKVxuXG4gICAgICAgIGlmIChicmVha3BvaW50IDw9IHdpbmRvdy5pbm5lcldpZHRoKSB7XG4gICAgICAgICAgU2NlbmUuZHVyYXRpb24oZHVyYXRpb25bYnJlYWtwb2ludF0pXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGZuKClcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aHJvdHRsZShmbiwgNzAwKSlcbiAgfSBlbHNlIHtcbiAgICBTY2VuZS5kdXJhdGlvbihkdXJhdGlvbilcbiAgfVxufVxuXG5jb25zdCBzZXRDbGFzc05hbWUgPSAoU2NlbmUsIG9wdGlvbnMsIGR1cmF0aW9uKSA9PiB7XG4gIGNvbnN0IHRvZ2dsZSA9IHtcbiAgICBjbGFzc05hbWU6IG51bGwsXG4gICAgZWxlbWVudDogbnVsbCxcbiAgICByZXZlcnNlOiBmYWxzZSxcbiAgICAuLi5vcHRpb25zLFxuICB9XG5cbiAgaWYgKCF0b2dnbGUuY2xhc3NOYW1lKSB7XG4gICAgZXJyb3JMb2cobmFtZVNwYWNlLCBgQmUgc3VyZSB0byBzZXQgYSBjbGFzc05hbWUgaW4gdGhlIG5ldyAke25hbWVTcGFjZX0oeyB0b2dnbGU6IHsgY2xhc3NOYW1lOiBcIm15LWNsYXNzXCIgfSB9KWApXG4gIH1cblxuICBpZiAoIXRvZ2dsZS5lbGVtZW50KSB7XG4gICAgZXJyb3JMb2coXG4gICAgICBuYW1lU3BhY2UsXG4gICAgICBgQmUgc3VyZSB0byBzZXQgYSBjb25zdCB0b2dnbGVFbGVtZW50ID0gKHJlYWN0UmVmLmN1cnJlbnQgb3IgZG9jdW1lbnQucXVlcnlTZWxlY3RvcikgaW4gdGhlIG5ldyAke25hbWVTcGFjZX0oeyB0b2dnbGU6IHsgZWxlbWVudDogdG9nZ2xlRWxlbWVudCB9IH0pYCxcbiAgICApXG4gIH1cblxuICBjb25zdCBhZGRDbGFzc05hbWUgPSAoKSA9PlxuICAgICF0b2dnbGUuZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnModG9nZ2xlLmNsYXNzTmFtZSkgJiYgdG9nZ2xlLmVsZW1lbnQuY2xhc3NMaXN0LmFkZCh0b2dnbGUuY2xhc3NOYW1lKVxuXG4gIGNvbnN0IHJlbW92ZUNsYXNzTmFtZSA9ICgpID0+XG4gICAgdG9nZ2xlLmVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKHRvZ2dsZS5jbGFzc05hbWUpICYmIHRvZ2dsZS5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUodG9nZ2xlLmNsYXNzTmFtZSlcblxuICBTY2VuZS5vbignZW50ZXInLCBmdW5jdGlvbigpIHtcbiAgICBhZGRDbGFzc05hbWUoKVxuICB9KVxuXG4gIFNjZW5lLm9uKCdhZGQnLCBmdW5jdGlvbigpIHtcbiAgICBpZiAoU2NlbmUuc3RhdGUoKSA9PT0gJ0RVUklORycpIHtcbiAgICAgIGFkZENsYXNzTmFtZSgpXG4gICAgfVxuICB9KVxuXG4gIFNjZW5lLm9uKCdsZWF2ZScsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgaWYgKCF0b2dnbGUucmV2ZXJzZSAmJiBkdXJhdGlvbikge1xuICAgICAgLy8gbmVlZHMgdG8gYmUgYmFzZWQgb24gd2hldGhlciBvciBub3Qgd2UgaGF2ZSBhIGR1cmF0aW9uXG4gICAgICBldmVudC5zY3JvbGxEaXJlY3Rpb24gPT09ICdSRVZFUlNFJyAmJiByZW1vdmVDbGFzc05hbWUoKVxuICAgIH0gZWxzZSB7XG4gICAgICByZW1vdmVDbGFzc05hbWUoKVxuICAgIH1cbiAgfSlcblxuICBTY2VuZS5vbigncmVtb3ZlJywgZnVuY3Rpb24oKSB7XG4gICAgcmVtb3ZlQ2xhc3NOYW1lKClcbiAgfSlcbn1cblxuY29uc3Qgc2V0VHdlZW4gPSAoU2NlbmUsIG9wdGlvbnMpID0+IHtcbiAgY29uc3QgZ3NhcCA9IHtcbiAgICBmb3J3YXJkU3BlZWQ6IDEsXG4gICAgcmV2ZXJzZVNwZWVkOiAxLFxuICAgIHRpbWVsaW5lOiBudWxsLFxuICAgIC4uLm9wdGlvbnMsXG4gIH1cblxuICBpZiAoIWdzYXAudGltZWxpbmUpIHtcbiAgICBlcnJvckxvZyhcbiAgICAgIG5hbWVTcGFjZSxcbiAgICAgIGBCZSBzdXJlIHRvIHNldCBhIGNvbnN0IHRsID0gZ3NhcC50aW1lbGluZSh7IHBhdXNlZDogdHJ1ZSB9KSBpbiB0aGUgbmV3ICR7bmFtZVNwYWNlfSh7IGdzYXA6IHsgdGltZWxpbmU6IHRsIH0gfSlgLFxuICAgIClcbiAgfVxuXG4gIFNjZW5lLm9uKCdwcm9ncmVzcycsIGZ1bmN0aW9uKCkge1xuICAgIHVwZGF0ZVR3ZWVuUHJvZ3Jlc3MoU2NlbmUsIGdzYXAudGltZWxpbmUsIGdzYXAuZm9yd2FyZFNwZWVkLCBnc2FwLnJldmVyc2VTcGVlZClcbiAgfSlcblxuICBTY2VuZS5vbigncmVtb3ZlJywgZnVuY3Rpb24oKSB7XG4gICAgcmVtb3ZlVHdlZW4oZ3NhcC50aW1lbGluZSlcbiAgfSlcbn1cblxuaW50ZXJmYWNlIElTY3JvbGxTY2VuZVRvZ2dsZSBleHRlbmRzIElTY3JvbGxPYnNlcnZlclRvZ2dsZSB7XG4gIC8qKlxuICAgKiByZXZlcnNlXG4gICAqIEBkZXNjIFNwZWNpZnkgdGhlIGNsYXNzTmFtZSBzaG91bGQgYmUgcmVtb3ZlZCBhZnRlciB0aGUgZHVyYXRpb24gb2Ygc2NlbmUgaXMgbWV0LiBPbmx5IGFwcGxpZXMgaWYgc2NlbmUgaGFzIGR1cmF0aW9uLlxuICAgKiBAdHlwZSBib29sZWFuXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqIEBleGFtcGxlXG4gICAqIHRvZ2dsZTogeyByZXZlcnNlOiB0cnVlIH1cbiAgICovXG4gIHJldmVyc2U/OiBib29sZWFuXG59XG5cbmludGVyZmFjZSBJU2Nyb2xsU2NlbmUge1xuICAvKipcbiAgICogYnJlYWtwb2ludHNcbiAgICogQGRlc2MgVXNlIHRvIHNldCByZXNwb25zaXZlbmVzcyBvZiB0aGUgbmV3IFNjcm9sbE1hZ2ljLlNjZW5lLCBtb2JpbGUtZmlyc3RcbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIGJyZWFrcG9pbnRzOiB7IDA6IGZhbHNlLCA3Njg6IHRydWUgfVxuICAgKi9cbiAgYnJlYWtwb2ludHM/OiBvYmplY3RcblxuICAvKipcbiAgICogY29udHJvbGxlclxuICAgKiBAZGVzYyBFeHRyYSBvcHRpb25zIHRvIHBhc3MgdGhlIG5ldyBTY3JvbGxNYWdpYy5Db250cm9sbGVyLCBsaWtlIHZlcnRpY2FsLCBldGMuXG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiBjb250cm9sbGVyOiB7IHZlcnRpY2FsOiBmYWxzZSB9XG4gICAqL1xuICBjb250cm9sbGVyPzogb2JqZWN0XG5cbiAgLyoqXG4gICAqIGR1cmF0aW9uXG4gICAqIEBkZXNjIFVzZSB0byBzZXQgcmVzcG9uc2l2ZW5lc3Mgb2YgdGhlIG5ldyBTY3JvbGxNYWdpYy5TY2VuZSwgbW9iaWxlLWZpcnN0IChpZiBzZXR0aW5nIGJyZWFrcG9pbnRzKVxuICAgKiBNdXN0IGJlIHN0cmluZyBmb3IgcGVyY2VudGFnZSwgYW5kIG51bWJlciBmb3IgcGl4ZWwuXG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiBkdXJhdGlvbjogJzEwMCUnID0gMTAwdmhcbiAgICogZHVyYXRpb246IDEwMCA9IDEwMHB4XG4gICAqIGR1cmF0aW9uOiB7IDA6ICc1MCUnLCA3Njg6ICcxMDAlIH0gLy8gPSBTY3JvbGxTY2VuZSBsYXN0cyA1MHZoIG9uIG1vYmlsZSwgMTAwJSBhZnRlclxuICAgKi9cbiAgZHVyYXRpb24/OiBzdHJpbmcgfCBudW1iZXIgfCBvYmplY3RcblxuICAvKipcbiAgICogZ3NhcFxuICAgKiBAZGVzYyBVc2UgdG8gc2V0IG9wdGlvbnMgZm9yIHRoZSBnc2FwIGFuaW1hdGlvbiBvZiB0aGUgU2Nyb2xsT2JzZXJ2ZXIuXG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiBnc2FwOiB7IHRpbWVsaW5lOiBteVRpbWVsaW5lLCB5b3lvOiB0cnVlLCByZXZlcnNlU3BlZWQ6IDIgfVxuICAgKi9cbiAgZ3NhcD86IElTY3JvbGxPYnNlcnZlckdzYXBcblxuICAvKipcbiAgICogdHJpZ2dlckhvb2tcbiAgICogQGRlc2MgU2V0IHRoZSBvZmZzZXQgb2YgdGhlIFNjcm9sbE1hZ2ljIHNjZW5lLlxuICAgKiBAdHlwZSAgbnVtYmVyIHwgc3RyaW5nXG4gICAqIEBkZWZhdWx0dmFsdWUgMFxuICAgKiBAZXhhbXBsZVxuICAgKiBvZmZzZXQ6IDEwMFxuICAgKiBvZmZzZXQ6ICcxMCUnXG4gICAqL1xuICBvZmZzZXQ/OiBudW1iZXIgfCBzdHJpbmdcblxuICAvKipcbiAgICogc2NlbmVcbiAgICogQGRlc2MgRXh0cmEgb3B0aW9ucyB0byBwYXNzIHRoZSBuZXcgU2Nyb2xsTWFnaWMuU2NlbmUsIGxpa2UgbG9nTGV2ZWwsIGV0Yy5cbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIHNjZW5lOiB7IGxvZ0xldmVsOiAyIH1cbiAgICovXG4gIHNjZW5lPzogb2JqZWN0XG5cbiAgLyoqXG4gICAqIHRvZ2dsZVxuICAgKiBAZGVzYyBVc2UgdG8gc2V0IHRoZSBvcHRpb25zIGZvciB0aGUgdG9nZ2xpbmcgb2YgYSBjbGFzc05hbWVcbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIHRvZ2dsZTogeyBlbGVtZW50OiBjb250YWluZXJSZWYuY3VycmVudCwgY2xhc3NOYW1lOiAnbGV0cy1kby10aGlzJyB9XG4gICAqL1xuICB0b2dnbGU/OiBJU2Nyb2xsU2NlbmVUb2dnbGVcblxuICAvKipcbiAgICogdHJpZ2dlckVsZW1lbnRcbiAgICogQGRlc2MgU2V0IHRoZSBlbGVtZW50IHlvdSB3aXNoIHRvIHRyaWdnZXIgZXZlbnRzIGJhc2VkIHVwb24sIHRoZSBvYnNlcnZlZCBlbGVtZW50LlxuICAgKiBAdHlwZSAgSFRNTEVsZW1lbnQgfCBhbnlcbiAgICogQGV4YW1wbGVcbiAgICogdHJpZ2dlckVsZW1lbnQ6IHRyaWdnZXJSZWYuY3VycmVudFxuICAgKi9cbiAgdHJpZ2dlckVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgYW55XG5cbiAgLyoqXG4gICAqIHRyaWdnZXJIb29rXG4gICAqIEBkZXNjIFNldCB0aGUgdHJpZ2dlckhvb2sgb2YgdGhlIFNjcm9sbE1hZ2ljIHNjZW5lLlxuICAgKiBAdHlwZSAgbnVtYmVyXG4gICAqIEBkZWZhdWx0dmFsdWUgJ29uRW50ZXInXG4gICAqIEBleGFtcGxlXG4gICAqIHRyaWdnZXJIb29rOiAwLjVcbiAgICovXG4gIHRyaWdnZXJIb29rPzogbnVtYmVyIHwgc3RyaW5nXG5cbiAgLyoqXG4gICAqIHVzZUdsb2JhbENvbnRyb2xsZXJcbiAgICogQGRlc2MgQ2hvc2Ugd2hldGhlciBvciBub3QgdG8gdXNlIHRoZSBnbG9iYWxDb250cm9sbGVyIHByb3ZpZGVkIGZvciB5b3UsIG9yIGEgZnJlc2ggbmV3IFNjcm9sbE1hZ2ljLkNvbnRyb2xsZXIgaW5zdGFuY2UuXG4gICAqIEB0eXBlIGJvb2xlYW5cbiAgICogQGRlZmF1bHRWYWx1ZSB0cnVlXG4gICAqIEBleGFtcGxlXG4gICAqIHVzZUdsb2JhbENvbnRyb2xsZXI6IGZhbHNlXG4gICAqL1xuICB1c2VHbG9iYWxDb250cm9sbGVyPzogYm9vbGVhblxufVxuXG4vLyBhZGQgY29udHJvbGxlciB2YXJcbmxldCBnbG9iYWxDb250cm9sbGVyXG5cbmNvbnN0IFNjcm9sbFNjZW5lID0gZnVuY3Rpb24oXG4gIHRoaXM6IGFueSxcbiAge1xuICAgIGJyZWFrcG9pbnRzLFxuICAgIGNvbnRyb2xsZXIgPSB7fSxcbiAgICBkdXJhdGlvbixcbiAgICBnc2FwLFxuICAgIG9mZnNldCA9IDAsXG4gICAgc2NlbmUgPSB7fSxcbiAgICB0b2dnbGUsXG4gICAgdHJpZ2dlckVsZW1lbnQsXG4gICAgdHJpZ2dlckhvb2sgPSAnb25FbnRlcicsXG4gICAgdXNlR2xvYmFsQ29udHJvbGxlciA9IHRydWUsXG4gIH06IElTY3JvbGxTY2VuZSxcbikge1xuICBsZXQgbG9jYWxDb250cm9sbGVyXG5cbiAgLy8gY2hlY2sgaWYgdXNpbmcgYSBsb2NhbCBjb250cm9sbGVyXG4gIGlmICghdXNlR2xvYmFsQ29udHJvbGxlcikge1xuICAgIGxvY2FsQ29udHJvbGxlciA9IG5ldyBTY3JvbGxNYWdpYy5Db250cm9sbGVyKGNvbnRyb2xsZXIpXG4gIH1cblxuICAvLyBtb3VudCBjb250cm9sbGVyXG4gIGlmICghZ2xvYmFsQ29udHJvbGxlciAmJiB1c2VHbG9iYWxDb250cm9sbGVyKSB7XG4gICAgZ2xvYmFsQ29udHJvbGxlciA9IG5ldyBTY3JvbGxNYWdpYy5Db250cm9sbGVyKGNvbnRyb2xsZXIpXG4gIH1cblxuICBjb25zdCBjb250cm9sbGVySXNVc2UgPSBsb2NhbENvbnRyb2xsZXIgPyBsb2NhbENvbnRyb2xsZXIgOiBnbG9iYWxDb250cm9sbGVyXG5cbiAgaWYgKCF0cmlnZ2VyRWxlbWVudCkge1xuICAgIGVycm9yTG9nKFxuICAgICAgbmFtZVNwYWNlLFxuICAgICAgYEJlIHN1cmUgdG8gc2V0IGEgY29uc3QgdHJpZ2dlckVsZW1lbnQgPSAocmVhY3RSZWYuY3VycmVudCBvciBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSBpbiB0aGUgbmV3ICR7bmFtZVNwYWNlfSh7IHRyaWdnZXJFbGVtZW50OiB0cmlnZ2VyRWxlbWVudCB9KWAsXG4gICAgKVxuICB9XG5cbiAgY29uc3QgU2NlbmUgPSBuZXcgU2Nyb2xsTWFnaWMuU2NlbmUoe1xuICAgIHRyaWdnZXJFbGVtZW50LFxuICAgIHRyaWdnZXJIb29rLFxuICAgIG9mZnNldCxcbiAgICAuLi5zY2VuZSxcbiAgfSlcblxuICBpZiAoZHVyYXRpb24pIHtcbiAgICBzZXREdXJhdGlvbihTY2VuZSwgZHVyYXRpb24pXG4gIH1cblxuICBpZiAodG9nZ2xlICYmIGlzT2JqZWN0KHRvZ2dsZSkpIHtcbiAgICBzZXRDbGFzc05hbWUoU2NlbmUsIHRvZ2dsZSwgZHVyYXRpb24pXG4gIH1cblxuICBpZiAoZ3NhcCAmJiBpc09iamVjdChnc2FwKSkge1xuICAgIHNldFR3ZWVuKFNjZW5lLCBnc2FwKVxuICB9XG5cbiAgdGhpcy5pbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgY29udHJvbGxlcklzVXNlICYmIFNjZW5lLmFkZFRvKGNvbnRyb2xsZXJJc1VzZSlcbiAgfVxuXG4gIHRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uKCkge1xuICAgIFNjZW5lLnJlbW92ZSgpXG4gIH1cblxuICB0aGlzLlNjZW5lID0gU2NlbmVcbiAgdGhpcy5Db250cm9sbGVyID0gY29udHJvbGxlcklzVXNlXG5cbiAgc2Nyb2xsQW5pbWF0aW9uSW5pdChicmVha3BvaW50cywgdGhpcy5pbml0LCB0aGlzLmRlc3Ryb3kpXG59XG5cbmV4cG9ydCB7IFNjcm9sbFNjZW5lIH1cbiJdfQ==