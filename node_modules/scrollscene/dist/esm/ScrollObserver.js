import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import { errorLog, isFunc, isObject, scrollAnimationInit, createArray, isString, stringContains } from "./helpers";
var nameSpace = 'ScrollObserver';

var state = function state(visible, alreadyFired) {
  this.visible = false;
  this.alreadyFired = false;
};

var setClassName = function setClassName(options) {
  var toggle = _objectSpread({
    element: null,
    className: null
  }, options);

  if (!toggle.element) {
    errorLog(nameSpace, "Be sure to set a const toggleElement = (reactRef.current or document.querySelector) in the new ".concat(nameSpace, "({ toggle: { element: toggleElement } })"));
  }

  if (!toggle.className) {
    errorLog(nameSpace, "Be sure to set the className you want to toggle in the new ".concat(nameSpace, "({ toggle: { className: \"my-class\" } })"));
  }

  this.add = function () {
    !toggle.element.classList.contains(toggle.className) && toggle.element.classList.add(toggle.className);
  };

  this.remove = function () {
    toggle.element.classList.contains(toggle.className) && toggle.element.classList.remove(toggle.className);
  };

  this.update = function (setState) {
    if (!setState.alreadyFired && setState.visible) {
      this.add();
      setState.alreadyFired = true;
    }

    if (setState.alreadyFired && !setState.visible) {
      this.remove();
      setState.alreadyFired = false;
    }
  };
};

var setTween = function setTween(options) {
  var gsap = _objectSpread({
    timeline: null,
    yoyo: false,
    speed: 1,
    reverseSpeed: 1,
    delay: 2
  }, options);

  if (!gsap.timeline) {
    errorLog(nameSpace, "Be sure to set a const tl = gsap.timeline({ paused: true }) in the new ".concat(nameSpace, "({ gsap: { timeline: tl } })"));
  }

  var tl = gsap.timeline;

  if (gsap.yoyo) {
    tl.repeat(-1).yoyo(gsap.yoyo).repeatDelay(gsap.delay);
  }

  this.play = function () {
    tl.timeScale(gsap.speed).play();
  };

  this.pause = function () {
    tl.pause();
  };

  this.reverse = function () {
    tl.timeScale(gsap.reverseSpeed).reverse();
  };

  this.kill = function () {
    if (tl) {
      tl.pause(0);
      tl.kill();
    }
  };

  this.update = function (setState) {
    if (!setState.alreadyFired && setState.visible) {
      this.play();
      setState.alreadyFired = true;
    }

    if (setState.alreadyFired && !setState.visible) {
      gsap.yoyo ? this.pause() : this.reverse();
      setState.alreadyFired = false;
    }
  };

  this.scrub = function (intersectionRatio) {
    tl.progress(intersectionRatio);
  };
};

var setPlayer = function setPlayer(options) {
  var video = _objectSpread({
    element: null
  }, options);

  if (!video.element) {
    errorLog(nameSpace, "Be sure to set a video element in the new ".concat(nameSpace, "({ video: { element: videoRef.current } })"));
  }

  this.play = function () {
    video.element.play();
  };

  this.pause = function () {
    video.element.pause();
  };

  this.kill = function () {
    video.element.pause();
  };

  this.update = function (setState) {
    if (!setState.alreadyFired && setState.visible) {
      this.play();
      setState.alreadyFired = true;
    }

    if (setState.alreadyFired && !setState.visible) {
      this.pause();
      setState.alreadyFired = false;
    }
  };
};

var setFunction = function setFunction(options) {
  var callback = _objectSpread({
    active: null,
    notActive: null
  }, options);

  if (!callback.active && !callback.notActive) {
    errorLog(nameSpace, "Be sure to set a callback active or notActive function in the new ".concat(nameSpace, "({ callback: { active: () => () } })"));
  }

  if (callback.active && !isFunc(callback.active) || callback.notActive && !isFunc(callback.notActive)) {
    errorLog(nameSpace, "Be sure to set the callback as a function ");
  }

  this.update = function (setState) {
    if (!setState.alreadyFired && setState.visible && callback.active) {
      callback.active();
      setState.alreadyFired = true;
    }

    if (setState.alreadyFired && !setState.visible && callback.active) {
      callback.notActive();
      setState.alreadyFired = false;
    }
  };
};

var ScrollObserver = function ScrollObserver(_ref) {
  var breakpoints = _ref.breakpoints,
      callback = _ref.callback,
      destroyImmediately = _ref.destroyImmediately,
      gsap = _ref.gsap,
      observer = _ref.observer,
      offset = _ref.offset,
      whenVisible = _ref.whenVisible,
      thresholds = _ref.thresholds,
      toggle = _ref.toggle,
      triggerElement = _ref.triggerElement,
      useDuration = _ref.useDuration,
      video = _ref.video;

  if (!triggerElement) {
    errorLog(nameSpace, 'Be sure to set a const triggerElement = (reactRef.current or document.querySelector) in the new ScrollScene({ triggerElement: triggerElement })');
  }

  var $this = this;
  var setToggle;
  var setGsap;
  var setVideo;
  var setCallback;
  var ratio;
  var setRootMargin = '0% 0%';
  var setState = new state(false, false);

  if (typeof offset === 'number') {
    setRootMargin = "-".concat(Math.abs(offset), "px 0%");
  } else if (typeof offset === 'string') {
    setRootMargin = "-".concat(Math.abs(parseFloat(offset)), "% 0%");
  }

  if (toggle && isObject(toggle)) {
    setToggle = new setClassName(toggle);
  }

  if (gsap && isObject(gsap)) {
    setGsap = new setTween(gsap);
  }

  if (video && isObject(video)) {
    setVideo = new setPlayer(video);
  }

  if (callback) {
    setCallback = new setFunction(callback);
  }

  var observerCallback = function observerCallback(entries) {
    entries.forEach(function (_ref2) {
      var isIntersecting = _ref2.isIntersecting,
          intersectionRatio = _ref2.intersectionRatio;

      if (ratio) {
        setState.visible = intersectionRatio >= ratio;
      } else if (isIntersecting && !setState.visible) {
        setState.visible = true;
      } else if (!isIntersecting && setState.visible) {
        setState.visible = false;
      }

      setToggle && setToggle.update(setState);
      setGsap && (!useDuration ? setGsap.update(setState) : setGsap.scrub(intersectionRatio));
      setVideo && setVideo.update(setState);
      setCallback && setCallback.update(setState);

      if (isIntersecting && destroyImmediately) {
        $this.destroy();
      }
    });
  };

  var getPercentage = function getPercentage(value) {
    if (!isString(whenVisible) && !stringContains(whenVisible, '%')) {
      errorLog(nameSpace, 'Be sure to set a percentage as a string. { whenVisible: "50%" }');
    }

    var parsed = parseInt(value.replace('%', '')) / 100;
    ratio = parsed;
    return parsed;
  };

  var getThresolds = function getThresolds() {
    var defaults = {
      one: [0, 1],
      gsap: createArray(199)
    };
    var returnedThresholds = defaults.one;

    if (whenVisible) {
      returnedThresholds = getPercentage(whenVisible);
    }

    if (useDuration) {
      returnedThresholds = defaults.gsap;
    }

    if (thresholds) {
      returnedThresholds = createArray(thresholds);
    }

    return returnedThresholds;
  };

  var Observer = new IntersectionObserver(observerCallback, _objectSpread({
    threshold: getThresolds(),
    rootMargin: setRootMargin
  }, observer));

  this.init = function () {
    Observer.observe(triggerElement);
  };

  this.destroy = function () {
    if (triggerElement && Observer) {
      if (setToggle) {
        setToggle.remove();
      }

      if (setGsap) {
        setGsap.kill();
      }

      if (setVideo) {
        setVideo.kill();
      }

      Observer.unobserve(triggerElement);
    }
  };

  scrollAnimationInit(breakpoints, this.init, this.destroy);
};

export { ScrollObserver };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TY3JvbGxPYnNlcnZlci50cyJdLCJuYW1lcyI6WyJlcnJvckxvZyIsImlzRnVuYyIsImlzT2JqZWN0Iiwic2Nyb2xsQW5pbWF0aW9uSW5pdCIsImNyZWF0ZUFycmF5IiwiaXNTdHJpbmciLCJzdHJpbmdDb250YWlucyIsIm5hbWVTcGFjZSIsInN0YXRlIiwidmlzaWJsZSIsImFscmVhZHlGaXJlZCIsInNldENsYXNzTmFtZSIsIm9wdGlvbnMiLCJ0b2dnbGUiLCJlbGVtZW50IiwiY2xhc3NOYW1lIiwiYWRkIiwiY2xhc3NMaXN0IiwiY29udGFpbnMiLCJyZW1vdmUiLCJ1cGRhdGUiLCJzZXRTdGF0ZSIsInNldFR3ZWVuIiwiZ3NhcCIsInRpbWVsaW5lIiwieW95byIsInNwZWVkIiwicmV2ZXJzZVNwZWVkIiwiZGVsYXkiLCJ0bCIsInJlcGVhdCIsInJlcGVhdERlbGF5IiwicGxheSIsInRpbWVTY2FsZSIsInBhdXNlIiwicmV2ZXJzZSIsImtpbGwiLCJzY3J1YiIsImludGVyc2VjdGlvblJhdGlvIiwicHJvZ3Jlc3MiLCJzZXRQbGF5ZXIiLCJ2aWRlbyIsInNldEZ1bmN0aW9uIiwiY2FsbGJhY2siLCJhY3RpdmUiLCJub3RBY3RpdmUiLCJTY3JvbGxPYnNlcnZlciIsImJyZWFrcG9pbnRzIiwiZGVzdHJveUltbWVkaWF0ZWx5Iiwib2JzZXJ2ZXIiLCJvZmZzZXQiLCJ3aGVuVmlzaWJsZSIsInRocmVzaG9sZHMiLCJ0cmlnZ2VyRWxlbWVudCIsInVzZUR1cmF0aW9uIiwiJHRoaXMiLCJzZXRUb2dnbGUiLCJzZXRHc2FwIiwic2V0VmlkZW8iLCJzZXRDYWxsYmFjayIsInJhdGlvIiwic2V0Um9vdE1hcmdpbiIsIk1hdGgiLCJhYnMiLCJwYXJzZUZsb2F0Iiwib2JzZXJ2ZXJDYWxsYmFjayIsImVudHJpZXMiLCJmb3JFYWNoIiwiaXNJbnRlcnNlY3RpbmciLCJkZXN0cm95IiwiZ2V0UGVyY2VudGFnZSIsInZhbHVlIiwicGFyc2VkIiwicGFyc2VJbnQiLCJyZXBsYWNlIiwiZ2V0VGhyZXNvbGRzIiwiZGVmYXVsdHMiLCJvbmUiLCJyZXR1cm5lZFRocmVzaG9sZHMiLCJPYnNlcnZlciIsIkludGVyc2VjdGlvbk9ic2VydmVyIiwidGhyZXNob2xkIiwicm9vdE1hcmdpbiIsImluaXQiLCJvYnNlcnZlIiwidW5vYnNlcnZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxTQUFTQSxRQUFULEVBQW1CQyxNQUFuQixFQUEyQkMsUUFBM0IsRUFBcUNDLG1CQUFyQyxFQUEwREMsV0FBMUQsRUFBdUVDLFFBQXZFLEVBQWlGQyxjQUFqRjtBQUVBLElBQU1DLFNBQVMsR0FBRyxnQkFBbEI7O0FBR0EsSUFBTUMsS0FBSyxHQUFHLFNBQVJBLEtBQVEsQ0FBU0MsT0FBVCxFQUFrQkMsWUFBbEIsRUFBZ0M7QUFDNUMsT0FBS0QsT0FBTCxHQUFlLEtBQWY7QUFDQSxPQUFLQyxZQUFMLEdBQW9CLEtBQXBCO0FBQ0QsQ0FIRDs7QUFLQSxJQUFNQyxZQUFZLEdBQUcsU0FBZkEsWUFBZSxDQUFvQkMsT0FBcEIsRUFBNkI7QUFDaEQsTUFBTUMsTUFBTTtBQUNWQyxJQUFBQSxPQUFPLEVBQUUsSUFEQztBQUVWQyxJQUFBQSxTQUFTLEVBQUU7QUFGRCxLQUdQSCxPQUhPLENBQVo7O0FBTUEsTUFBSSxDQUFDQyxNQUFNLENBQUNDLE9BQVosRUFBcUI7QUFDbkJkLElBQUFBLFFBQVEsQ0FDTk8sU0FETSwyR0FFNEZBLFNBRjVGLDhDQUFSO0FBSUQ7O0FBRUQsTUFBSSxDQUFDTSxNQUFNLENBQUNFLFNBQVosRUFBdUI7QUFDckJmLElBQUFBLFFBQVEsQ0FDTk8sU0FETSx1RUFFd0RBLFNBRnhELCtDQUFSO0FBSUQ7O0FBRUQsT0FBS1MsR0FBTCxHQUFXLFlBQVc7QUFFcEIsS0FBQ0gsTUFBTSxDQUFDQyxPQUFQLENBQWVHLFNBQWYsQ0FBeUJDLFFBQXpCLENBQWtDTCxNQUFNLENBQUNFLFNBQXpDLENBQUQsSUFBd0RGLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlRyxTQUFmLENBQXlC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RyxXQUFKLEVBQWlCO0FBQ2Z3QixNQUFBQSxrQkFBa0IsR0FBR0YsUUFBUSxDQUFDckQsSUFBOUI7QUFDRDs7QUFFRCxRQUFJNkIsVUFBSixFQUFnQjtBQUNkMEIsTUFBQUEsa0JBQWtCLEdBQUcxRSxXQUFXLENBQUNnRCxVQUFELENBQWhDO0FBQ0Q7O0FBRUQsV0FBTzBCLGtCQUFQO0FBQ0QsR0FyQkQ7O0FBdUJBLE1BQU1DLFFBQVEsR0FBRyxJQUFJQyxvQkFBSixDQUF5QmYsZ0JBQXpCO0FBQ2ZnQixJQUFBQSxTQUFTLEVBQUVOLFlBQVksRUFEUjtBQUVmTyxJQUFBQSxVQUFVLEVBQUVyQjtBQUZHLEtBR1paLFFBSFksRUFBakI7O0FBTUEsT0FBS2tDLElBQUwsR0FBWSxZQUFXO0FBQ3JCSixJQUFBQSxRQUFRLENBQUNLLE9BQVQsQ0FBaUIvQixjQUFqQjtBQUNELEdBRkQ7O0FBSUEsT0FBS2dCLE9BQUwsR0FBZSxZQUFXO0FBQ3hCLFFBQUloQixjQUFjLElBQUkwQixRQUF0QixFQUFnQztBQUM5QixVQUFJdkIsU0FBSixFQUFlO0FBQ2JBLFFBQUFBLFNBQVMsQ0FBQ3JDLE1BQVY7QUFDRDs7QUFFRCxVQUFJc0MsT0FBSixFQUFhO0FBQ1hBLFFBQUFBLE9BQU8sQ0FBQ3JCLElBQVI7QUFDRDs7QUFFRCxVQUFJc0IsUUFBSixFQUFjO0FBQ1pBLFFBQUFBLFFBQVEsQ0FBQ3RCLElBQVQ7QUFDRDs7QUFFRDJDLE1BQUFBLFFBQVEsQ0FBQ00sU0FBVCxDQUFtQmhDLGNBQW5CO0FBQ0Q7QUFDRixHQWhCRDs7QUFrQkFsRCxFQUFBQSxtQkFBbUIsQ0FBQzRDLFdBQUQsRUFBYyxLQUFLb0MsSUFBbkIsRUFBeUIsS0FBS2QsT0FBOUIsQ0FBbkI7QUFDRCxDQXhKRDs7QUEwSkEsU0FBU3ZCLGNBQVQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvckxvZywgaXNGdW5jLCBpc09iamVjdCwgc2Nyb2xsQW5pbWF0aW9uSW5pdCwgY3JlYXRlQXJyYXksIGlzU3RyaW5nLCBzdHJpbmdDb250YWlucyB9IGZyb20gJy4vaGVscGVycydcblxuY29uc3QgbmFtZVNwYWNlID0gJ1Njcm9sbE9ic2VydmVyJ1xuXG4vLyBAdHMtaWdub3JlXG5jb25zdCBzdGF0ZSA9IGZ1bmN0aW9uKHZpc2libGUsIGFscmVhZHlGaXJlZCkge1xuICB0aGlzLnZpc2libGUgPSBmYWxzZVxuICB0aGlzLmFscmVhZHlGaXJlZCA9IGZhbHNlXG59XG5cbmNvbnN0IHNldENsYXNzTmFtZSA9IGZ1bmN0aW9uKHRoaXM6IGFueSwgb3B0aW9ucykge1xuICBjb25zdCB0b2dnbGUgPSB7XG4gICAgZWxlbWVudDogbnVsbCxcbiAgICBjbGFzc05hbWU6IG51bGwsXG4gICAgLi4ub3B0aW9ucyxcbiAgfVxuXG4gIGlmICghdG9nZ2xlLmVsZW1lbnQpIHtcbiAgICBlcnJvckxvZyhcbiAgICAgIG5hbWVTcGFjZSxcbiAgICAgIGBCZSBzdXJlIHRvIHNldCBhIGNvbnN0IHRvZ2dsZUVsZW1lbnQgPSAocmVhY3RSZWYuY3VycmVudCBvciBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSBpbiB0aGUgbmV3ICR7bmFtZVNwYWNlfSh7IHRvZ2dsZTogeyBlbGVtZW50OiB0b2dnbGVFbGVtZW50IH0gfSlgLFxuICAgIClcbiAgfVxuXG4gIGlmICghdG9nZ2xlLmNsYXNzTmFtZSkge1xuICAgIGVycm9yTG9nKFxuICAgICAgbmFtZVNwYWNlLFxuICAgICAgYEJlIHN1cmUgdG8gc2V0IHRoZSBjbGFzc05hbWUgeW91IHdhbnQgdG8gdG9nZ2xlIGluIHRoZSBuZXcgJHtuYW1lU3BhY2V9KHsgdG9nZ2xlOiB7IGNsYXNzTmFtZTogXCJteS1jbGFzc1wiIH0gfSlgLFxuICAgIClcbiAgfVxuXG4gIHRoaXMuYWRkID0gZnVuY3Rpb24oKSB7XG4gICAgLyogYWRkIGNsYXNzTmFtZSBpZiBpdCdzIG5vdCBhbHJlYWR5IHRoZXJlICovXG4gICAgIXRvZ2dsZS5lbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyh0b2dnbGUuY2xhc3NOYW1lKSAmJiB0b2dnbGUuZWxlbWVudC5jbGFzc0xpc3QuYWRkKHRvZ2dsZS5jbGFzc05hbWUpXG4gIH1cblxuICB0aGlzLnJlbW92ZSA9IGZ1bmN0aW9uKCkge1xuICAgIC8qIHJlbW92ZSBjbGFzc05hbWUgaWYgaXQncyB0aGVyZSAqL1xuICAgIHRvZ2dsZS5lbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyh0b2dnbGUuY2xhc3NOYW1lKSAmJiB0b2dnbGUuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKHRvZ2dsZS5jbGFzc05hbWUpXG4gIH1cblxuICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uKHNldFN0YXRlKSB7XG4gICAgaWYgKCFzZXRTdGF0ZS5hbHJlYWR5RmlyZWQgJiYgc2V0U3RhdGUudmlzaWJsZSkge1xuICAgICAgdGhpcy5hZGQoKVxuICAgICAgc2V0U3RhdGUuYWxyZWFkeUZpcmVkID0gdHJ1ZVxuICAgIH1cblxuICAgIGlmIChzZXRTdGF0ZS5hbHJlYWR5RmlyZWQgJiYgIXNldFN0YXRlLnZpc2libGUpIHtcbiAgICAgIHRoaXMucmVtb3ZlKClcbiAgICAgIHNldFN0YXRlLmFscmVhZHlGaXJlZCA9IGZhbHNlXG4gICAgfVxuICB9XG59XG5cbmNvbnN0IHNldFR3ZWVuID0gZnVuY3Rpb24odGhpczogYW55LCBvcHRpb25zKSB7XG4gIGNvbnN0IGdzYXAgPSB7XG4gICAgdGltZWxpbmU6IG51bGwsXG4gICAgeW95bzogZmFsc2UsXG4gICAgc3BlZWQ6IDEsXG4gICAgcmV2ZXJzZVNwZWVkOiAxLFxuICAgIGRlbGF5OiAyLFxuICAgIC4uLm9wdGlvbnMsXG4gIH1cblxuICBpZiAoIWdzYXAudGltZWxpbmUpIHtcbiAgICBlcnJvckxvZyhcbiAgICAgIG5hbWVTcGFjZSxcbiAgICAgIGBCZSBzdXJlIHRvIHNldCBhIGNvbnN0IHRsID0gZ3NhcC50aW1lbGluZSh7IHBhdXNlZDogdHJ1ZSB9KSBpbiB0aGUgbmV3ICR7bmFtZVNwYWNlfSh7IGdzYXA6IHsgdGltZWxpbmU6IHRsIH0gfSlgLFxuICAgIClcbiAgfVxuXG4gIGNvbnN0IHRsID0gZ3NhcC50aW1lbGluZVxuXG4gIGlmIChnc2FwLnlveW8pIHtcbiAgICB0bC5yZXBlYXQoLTEpXG4gICAgICAueW95byhnc2FwLnlveW8pXG4gICAgICAucmVwZWF0RGVsYXkoZ3NhcC5kZWxheSlcbiAgfVxuXG4gIHRoaXMucGxheSA9IGZ1bmN0aW9uKCkge1xuICAgIHRsLnRpbWVTY2FsZShnc2FwLnNwZWVkKS5wbGF5KClcbiAgfVxuXG4gIHRoaXMucGF1c2UgPSBmdW5jdGlvbigpIHtcbiAgICB0bC5wYXVzZSgpXG4gIH1cblxuICB0aGlzLnJldmVyc2UgPSBmdW5jdGlvbigpIHtcbiAgICB0bC50aW1lU2NhbGUoZ3NhcC5yZXZlcnNlU3BlZWQpLnJldmVyc2UoKVxuICB9XG5cbiAgdGhpcy5raWxsID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRsKSB7XG4gICAgICB0bC5wYXVzZSgwKVxuICAgICAgdGwua2lsbCgpXG4gICAgfVxuICB9XG5cbiAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbihzZXRTdGF0ZSkge1xuICAgIGlmICghc2V0U3RhdGUuYWxyZWFkeUZpcmVkICYmIHNldFN0YXRlLnZpc2libGUpIHtcbiAgICAgIHRoaXMucGxheSgpXG4gICAgICBzZXRTdGF0ZS5hbHJlYWR5RmlyZWQgPSB0cnVlXG4gICAgfVxuXG4gICAgaWYgKHNldFN0YXRlLmFscmVhZHlGaXJlZCAmJiAhc2V0U3RhdGUudmlzaWJsZSkge1xuICAgICAgZ3NhcC55b3lvID8gdGhpcy5wYXVzZSgpIDogdGhpcy5yZXZlcnNlKClcbiAgICAgIHNldFN0YXRlLmFscmVhZHlGaXJlZCA9IGZhbHNlXG4gICAgfVxuICB9XG5cbiAgdGhpcy5zY3J1YiA9IGZ1bmN0aW9uKGludGVyc2VjdGlvblJhdGlvKSB7XG4gICAgdGwucHJvZ3Jlc3MoaW50ZXJzZWN0aW9uUmF0aW8pXG4gIH1cbn1cblxuY29uc3Qgc2V0UGxheWVyID0gZnVuY3Rpb24odGhpczogYW55LCBvcHRpb25zKSB7XG4gIGNvbnN0IHZpZGVvID0ge1xuICAgIGVsZW1lbnQ6IG51bGwsXG4gICAgLi4ub3B0aW9ucyxcbiAgfVxuXG4gIGlmICghdmlkZW8uZWxlbWVudCkge1xuICAgIGVycm9yTG9nKFxuICAgICAgbmFtZVNwYWNlLFxuICAgICAgYEJlIHN1cmUgdG8gc2V0IGEgdmlkZW8gZWxlbWVudCBpbiB0aGUgbmV3ICR7bmFtZVNwYWNlfSh7IHZpZGVvOiB7IGVsZW1lbnQ6IHZpZGVvUmVmLmN1cnJlbnQgfSB9KWAsXG4gICAgKVxuICB9XG5cbiAgdGhpcy5wbGF5ID0gZnVuY3Rpb24oKSB7XG4gICAgdmlkZW8uZWxlbWVudC5wbGF5KClcbiAgfVxuXG4gIHRoaXMucGF1c2UgPSBmdW5jdGlvbigpIHtcbiAgICB2aWRlby5lbGVtZW50LnBhdXNlKClcbiAgfVxuXG4gIHRoaXMua2lsbCA9IGZ1bmN0aW9uKCkge1xuICAgIHZpZGVvLmVsZW1lbnQucGF1c2UoKVxuICB9XG5cbiAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbihzZXRTdGF0ZSkge1xuICAgIGlmICghc2V0U3RhdGUuYWxyZWFkeUZpcmVkICYmIHNldFN0YXRlLnZpc2libGUpIHtcbiAgICAgIHRoaXMucGxheSgpXG4gICAgICBzZXRTdGF0ZS5hbHJlYWR5RmlyZWQgPSB0cnVlXG4gICAgfVxuXG4gICAgaWYgKHNldFN0YXRlLmFscmVhZHlGaXJlZCAmJiAhc2V0U3RhdGUudmlzaWJsZSkge1xuICAgICAgdGhpcy5wYXVzZSgpXG4gICAgICBzZXRTdGF0ZS5hbHJlYWR5RmlyZWQgPSBmYWxzZVxuICAgIH1cbiAgfVxufVxuXG5jb25zdCBzZXRGdW5jdGlvbjogYW55ID0gZnVuY3Rpb24odGhpczogYW55LCBvcHRpb25zKSB7XG4gIGNvbnN0IGNhbGxiYWNrID0ge1xuICAgIGFjdGl2ZTogbnVsbCxcbiAgICBub3RBY3RpdmU6IG51bGwsXG4gICAgLi4ub3B0aW9ucyxcbiAgfVxuXG4gIGlmICghY2FsbGJhY2suYWN0aXZlICYmICFjYWxsYmFjay5ub3RBY3RpdmUpIHtcbiAgICBlcnJvckxvZyhcbiAgICAgIG5hbWVTcGFjZSxcbiAgICAgIGBCZSBzdXJlIHRvIHNldCBhIGNhbGxiYWNrIGFjdGl2ZSBvciBub3RBY3RpdmUgZnVuY3Rpb24gaW4gdGhlIG5ldyAke25hbWVTcGFjZX0oeyBjYWxsYmFjazogeyBhY3RpdmU6ICgpID0+ICgpIH0gfSlgLFxuICAgIClcbiAgfVxuXG4gIGlmICgoY2FsbGJhY2suYWN0aXZlICYmICFpc0Z1bmMoY2FsbGJhY2suYWN0aXZlKSkgfHwgKGNhbGxiYWNrLm5vdEFjdGl2ZSAmJiAhaXNGdW5jKGNhbGxiYWNrLm5vdEFjdGl2ZSkpKSB7XG4gICAgZXJyb3JMb2cobmFtZVNwYWNlLCBgQmUgc3VyZSB0byBzZXQgdGhlIGNhbGxiYWNrIGFzIGEgZnVuY3Rpb24gYClcbiAgfVxuXG4gIHRoaXMudXBkYXRlID0gZnVuY3Rpb24oc2V0U3RhdGUpIHtcbiAgICBpZiAoIXNldFN0YXRlLmFscmVhZHlGaXJlZCAmJiBzZXRTdGF0ZS52aXNpYmxlICYmIGNhbGxiYWNrLmFjdGl2ZSkge1xuICAgICAgY2FsbGJhY2suYWN0aXZlKClcbiAgICAgIHNldFN0YXRlLmFscmVhZHlGaXJlZCA9IHRydWVcbiAgICB9XG5cbiAgICBpZiAoc2V0U3RhdGUuYWxyZWFkeUZpcmVkICYmICFzZXRTdGF0ZS52aXNpYmxlICYmIGNhbGxiYWNrLmFjdGl2ZSkge1xuICAgICAgY2FsbGJhY2subm90QWN0aXZlKClcbiAgICAgIHNldFN0YXRlLmFscmVhZHlGaXJlZCA9IGZhbHNlXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNjcm9sbE9ic2VydmVyR3NhcCB7XG4gIC8qKlxuICAgKiB0aW1lbGluZVxuICAgKiBAZGVzYyBJbnNlcnQgeW91ciBnc2FwLnRpbWVsaW5lIG9iamVjdCB2YXJcbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIGNvbnN0IG15VGltZWxpbmUgPSBnc2FwLnRpbWVsaW5lKClcbiAgICogZ3NhcDogeyB0aW1lbGluZTogbXlUaW1lbGluZSB9XG4gICAqL1xuICB0aW1lbGluZTogYW55XG5cbiAgLyoqXG4gICAqIHlveW9cbiAgICogQGRlc2MgRG8geW91IHdhbnQgZ3NhcCBhbmltYXRpb24gdG8gbG9vcCBiYWNrIGFuZCBmb3J0aD9cbiAgICogQHR5cGUgYm9vbGVhblxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKiBAZXhhbXBsZVxuICAgKiBnc2FwOiB7IHlveW86IHRydWUgfVxuICAgKi9cbiAgeW95bz86IGJvb2xlYW5cblxuICAvKipcbiAgICogc3BlZWRcbiAgICogQGRlc2MgVGhlIHNwZWVkIGF0IHdoaWNoIHRoZSBnc2FwIGFuaW1hdGlvbiB3aWxsIHBsYXkgcmVsYXRpdmUgdG8gaXQncyBjdXJyZW50IHNwZWVkLlxuICAgKiBAdHlwZSBudW1iZXJcbiAgICogQGRlZmF1bHQgMVxuICAgKiBAZXhhbXBsZVxuICAgKiBnc2FwOiB7IHNwZWVkOiAyIH0gLy8gPSB0d2ljZSBhcyBmYXN0XG4gICAqL1xuICBzcGVlZD86IG51bWJlclxuXG4gIC8qKlxuICAgKiBzcGVlZFxuICAgKiBAZGVzYyBUaGUgc3BlZWQgYXQgd2hpY2ggdGhlIGdzYXAgYW5pbWF0aW9uIHdpbGwgcmV2ZXJzZSByZWxhdGl2ZSB0byBpdCdzIGN1cnJlbnQgc3BlZWQuXG4gICAqIEB0eXBlIG51bWJlclxuICAgKiBAZGVmYXVsdCA0XG4gICAqIEBleGFtcGxlXG4gICAqIGdzYXA6IHsgc3BlZWQ6IDQgfSAvLyA9IDR4IGFzIGZhc3RcbiAgICovXG4gIHJldmVyc2VTcGVlZD86IG51bWJlclxuXG4gIC8qKlxuICAgKiBkZWxheVxuICAgKiBAZGVzYyBUaGUgZGVsYXkgKGluIHNlY29uZHMpIGF0IHdoaWNoIHRoZSBnc2FwIGFuaW1hdGlvbiB3YWl0IGJlZm9yZSByZXZlcnNpbmcuXG4gICAqIEB0eXBlIG51bWJlclxuICAgKiBAZGVmYXVsdCAyXG4gICAqIEBleGFtcGxlXG4gICAqIGdzYXA6IHsgZGVsYXk6IDMgfSAvLyA9IFdhaXQgMyBzZWNvbmRzXG4gICAqL1xuICBkZWxheT86IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTY3JvbGxPYnNlcnZlclRvZ2dsZSB7XG4gIC8qKlxuICAgKiBjbGFzc05hbWVcbiAgICogQGRlc2MgU3BlY2lmeSB0aGUgY2xhc3NOYW1lIHlvdSB3aXNoIHRvIHRvZ2dsZS5cbiAgICogQHR5cGUgc3RyaW5nXG4gICAqIEBleGFtcGxlXG4gICAqIHRvZ2dsZTogeyBjbGFzc05hbWU6ICd0dXJuLW1lLWJsdWUtYmFieScgfVxuICAgKi9cbiAgY2xhc3NOYW1lOiBzdHJpbmdcblxuICAvKipcbiAgICogZWxlbWVudFxuICAgKiBAZGVzYyBTcGVjaWZ5IHRoZSBlbGVtZW50IHlvdSB3aXNoIHRvIHRvZ2dsZSB0aGUgY2xhc3NOYW1lIG9uLlxuICAgKiBAdHlwZSBIVE1MRWxlbWVudCB8IGFueVxuICAgKiBAZXhhbXBsZVxuICAgKiB0b2dnbGU6IHsgZWxlbWVudDogY29udGFpbmVyUmVmLmN1cnJlbnQgfVxuICAgKi9cbiAgZWxlbWVudDogSFRNTEVsZW1lbnQgfCBhbnlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU2Nyb2xsT2JzZXJ2ZXJWaWRlbyB7XG4gIC8qKlxuICAgKiBlbGVtZW50XG4gICAqIEBkZXNjIFNwZWNpZnkgdGhlIHZpZGVvIGVsZW1lbnQgeW91IHdpc2ggdG8gaW50ZXJhY3Qgd2l0aC5cbiAgICogQHR5cGUgSFRNTEVsZW1lbnQgfCBhbnlcbiAgICogQGV4YW1wbGVcbiAgICogdmlkZW86IHsgZWxlbWVudDogdmlkZW9SZWYuY3VycmVudCB9XG4gICAqL1xuICBlbGVtZW50OiBIVE1MRWxlbWVudCB8IGFueVxufVxuXG5pbnRlcmZhY2UgSVNjcm9sbE9ic2VydmVyIHtcbiAgLyoqXG4gICAqIGJyZWFrcG9pbnRzXG4gICAqIEBkZXNjIFVzZSB0byBzZXQgcmVzcG9uc2l2ZW5lc3Mgb2YgdGhlIFNjcm9sbE9ic2VydmVyLCBtb2JpbGUtZmlyc3RcbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIGJyZWFrcG9pbnRzOiB7IDA6IGZhbHNlLCA3Njg6IHRydWUgfVxuICAgKi9cbiAgYnJlYWtwb2ludHM/OiBvYmplY3RcblxuICAvKipcbiAgICogY2FsbGJhY2tcbiAgICogQGRlc2MgVXNlIHRvIHNldCBhIGNhbGxiYWNrIHdoZW4gdGhlIHNjZW5lIGlzIGFjdGl2ZS5cbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIGNhbGxiYWNrOiB7IGFjdGl2ZTogKCkgPT4gKCksIG5vdEFjdGl2ZTogKCkgPT4gKCkgfVxuICAgKi9cbiAgY2FsbGJhY2s/OiBvYmplY3RcblxuICAvKipcbiAgICogZGVzdHJveUltbWVkaWF0ZWx5XG4gICAqIEBkZXNjIFVzZSB0byBkZXN0cm95IHRoZSBzY2VuZSBpbW1lZGlhdGVseSBhZnRlciBmaXJpbmcgb25jZSB0aGUgZWxlbWVudCBpcyB2aXNpYmxlLlxuICAgKiBAdHlwZSBib29sZWFuXG4gICAqIEBleGFtcGxlXG4gICAqIGRlc3Ryb3lJbW1lZGlhdGVseTogdHJ1ZVxuICAgKi9cbiAgZGVzdHJveUltbWVkaWF0ZWx5PzogYm9vbGVhblxuXG4gIC8qKlxuICAgKiBnc2FwXG4gICAqIEBkZXNjIFVzZSB0byBzZXQgb3B0aW9ucyBmb3IgdGhlIGdzYXAgYW5pbWF0aW9uIG9mIHRoZSBTY3JvbGxPYnNlcnZlci5cbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIGdzYXA6IHsgdGltZWxpbmU6IG15VGltZWxpbmUsIHlveW86IHRydWUsIHJldmVyc2VTcGVlZDogMiB9XG4gICAqL1xuICBnc2FwPzogSVNjcm9sbE9ic2VydmVyR3NhcFxuXG4gIC8qKlxuICAgKiBvYnNlcnZlclxuICAgKiBAZGVzYyBFeHRyYSBvcHRpb25zIHRvIHBhc3MgdGhlIEludGVyc2VjdGlvbk9ic2VydmVyLCBsaWtlIHJvb3QsIHJvb3RNYXJnaW4sIHRocmVzaG9sZCAodG8gb3ZlcnJpZGUgdGhlIHRocmVzaG9sZHMgb3B0aW9uKVxuICAgKiBAdHlwZSBvYmplY3RcbiAgICogQGV4YW1wbGVcbiAgICogb2JzZXJ2ZXI6IHsgcm9vdE1hcmdpbjogJy01MCUgMCUnIH1cbiAgICovXG4gIG9ic2VydmVyPzogb2JqZWN0XG5cbiAgLyoqXG4gICAqIG9mZnNldFxuICAgKiBAZGVzYyBDaGFuZ2UgdGhlIG9mZnNldC4gVGhpcyB1c2VzIHJvb3RNYXJnaW4gdGh1cyBvbmx5IHdvcmtzIGFzIGEgbmVnYXRpdmUgb2Zmc2V0LlxuICAgKiBAdHlwZSBudW1iZXIgfCBzdHJpbmdcbiAgICogQGRlZmF1bHR2YWx1ZSAnMCUgMCUnXG4gICAqIEBleGFtcGxlXG4gICAqIG9mZnNldDogNTAwIC8vIHRoaXMgd2lsbCBiZSByb290TWFyZ2luOiAnLTUwMHB4IDAlJ1xuICAgKi9cbiAgb2Zmc2V0PzogbnVtYmVyIHwgc3RyaW5nXG5cbiAgLyoqXG4gICAqIHRocmVzaG9sZHNcbiAgICogQGRlc2MgU2V0IHRoZSBudW1iZXIgb2YgdGhyZXNob2xkcyB5b3Ugd2FudC5cbiAgICogQHJldHVybnMgQW4gQXJyYXkgb2YgbnVtYmVyIGZyb20gMCB0byAxLiBBZGQgMSB0byB5b3VyIG51bWJlciB0byBhY2NvdW50IGZvciAwLlxuICAgKiBAdHlwZSBudW1iZXJcbiAgICogQGV4YW1wbGVcbiAgICogdGhyZXNob2xkczogMSA9IFswLCAxXVxuICAgKiB0aHJlc2hvbGRzOiAyID0gWzAsIDAuNSwgMV1cbiAgICogdGhyZXNob2xkczogMyA9IFswLCAwLjMzLCAwLjY3LCAxXVxuICAgKiB0aHJlc2hvbGRzOiAxMDAgPSBbMCwgMC4xLCAwLjIsIC4uLiAwLjk4LCAwLjk5LCAxXVxuICAgKi9cbiAgdGhyZXNob2xkcz86IG51bWJlclxuXG4gIC8qKlxuICAgKiB0b2dnbGVcbiAgICogQGRlc2MgVXNlIHRvIHNldCB0aGUgb3B0aW9ucyBmb3IgdGhlIHRvZ2dsaW5nIG9mIGEgY2xhc3NOYW1lXG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiB0b2dnbGU6IHsgZWxlbWVudDogY29udGFpbmVyUmVmLmN1cnJlbnQsIGNsYXNzTmFtZTogJ2xldHMtZG8tdGhpcycgfVxuICAgKi9cbiAgdG9nZ2xlPzogSVNjcm9sbE9ic2VydmVyVG9nZ2xlXG5cbiAgLyoqXG4gICAqIHRyaWdnZXJFbGVtZW50XG4gICAqIEBkZXNjIFNldCB0aGUgZWxlbWVudCB5b3Ugd2lzaCB0byB0cmlnZ2VyIGV2ZW50cyBiYXNlZCB1cG9uLCB0aGUgb2JzZXJ2ZWQgZWxlbWVudC5cbiAgICogQHR5cGUgSFRNTEVsZW1lbnQgfCBhbnlcbiAgICogQGV4YW1wbGVcbiAgICogdHJpZ2dlckVsZW1lbnQ6IHRyaWdnZXJSZWYuY3VycmVudFxuICAgKi9cbiAgdHJpZ2dlckVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgYW55XG5cbiAgLyoqXG4gICAqIHVzZUR1cmF0aW9uXG4gICAqIEBkZXNjIFVzZSB0aGUgcGVyY2VudGFnZSBvZiBlbGVtZW50IHZpc2liaWxpdHkgdG8gc2NydWIgdGhlIGdzYXAgdGltZWxpbmUuXG4gICAqIEB0eXBlIGJvb2xlYW5cbiAgICogQGV4YW1wbGVcbiAgICogdXNlRHVyYXRpb246IHRydWVcbiAgICovXG4gIHVzZUR1cmF0aW9uPzogYm9vbGVhblxuXG4gIC8qKlxuICAgKiB2aWRlb1xuICAgKiBAZGVzYyBVc2UgdG8gc2V0IHRoZSBvcHRpb25zIGZvciBwbGF5aW5nIGFuZCBwYXVzaW5nIG9mIHRoZSB2aWRlby5cbiAgICogQHR5cGUgb2JqZWN0XG4gICAqIEBleGFtcGxlXG4gICAqIHZpZGVvOiB7IGVsZW1lbnQ6IHZpZGVvUmVmLmN1cnJlbnQgfVxuICAgKi9cbiAgdmlkZW8/OiBJU2Nyb2xsT2JzZXJ2ZXJWaWRlb1xuXG4gIC8qKlxuICAgKiB3aGVuVmlzaWJsZVxuICAgKiBAZGVzYyBTZXQgd2hlbiB0aGUgc2NlbmUgc2hvdWxkIGJlIGFjdGl2ZSBiYXNlZCBvbiB0aGUgcGVyY2VudGFnZSBvZiB0aGUgZWxlbWVudCB2aXNpYmxlXG4gICAqIEB0eXBlIG51bWJlclxuICAgKiBAZXhhbXBsZVxuICAgKiB3aGVuVmlzaWJsZTogJzUwJSdcbiAgICovXG4gIHdoZW5WaXNpYmxlPzogc3RyaW5nXG59XG5cbmNvbnN0IFNjcm9sbE9ic2VydmVyID0gZnVuY3Rpb24oXG4gIHRoaXM6IGFueSxcbiAge1xuICAgIGJyZWFrcG9pbnRzLFxuICAgIGNhbGxiYWNrLFxuICAgIGRlc3Ryb3lJbW1lZGlhdGVseSxcbiAgICBnc2FwLFxuICAgIG9ic2VydmVyLFxuICAgIG9mZnNldCxcbiAgICB3aGVuVmlzaWJsZSxcbiAgICB0aHJlc2hvbGRzLFxuICAgIHRvZ2dsZSxcbiAgICB0cmlnZ2VyRWxlbWVudCxcbiAgICB1c2VEdXJhdGlvbixcbiAgICB2aWRlbyxcbiAgfTogSVNjcm9sbE9ic2VydmVyLFxuKSB7XG4gIGlmICghdHJpZ2dlckVsZW1lbnQpIHtcbiAgICBlcnJvckxvZyhcbiAgICAgIG5hbWVTcGFjZSxcbiAgICAgICdCZSBzdXJlIHRvIHNldCBhIGNvbnN0IHRyaWdnZXJFbGVtZW50ID0gKHJlYWN0UmVmLmN1cnJlbnQgb3IgZG9jdW1lbnQucXVlcnlTZWxlY3RvcikgaW4gdGhlIG5ldyBTY3JvbGxTY2VuZSh7IHRyaWdnZXJFbGVtZW50OiB0cmlnZ2VyRWxlbWVudCB9KScsXG4gICAgKVxuICB9XG5cbiAgY29uc3QgJHRoaXMgPSB0aGlzXG4gIGxldCBzZXRUb2dnbGVcbiAgbGV0IHNldEdzYXBcbiAgbGV0IHNldFZpZGVvXG4gIGxldCBzZXRDYWxsYmFja1xuICBsZXQgcmF0aW9cbiAgbGV0IHNldFJvb3RNYXJnaW4gPSAnMCUgMCUnXG4gIGxldCBzZXRTdGF0ZSA9IG5ldyBzdGF0ZShmYWxzZSwgZmFsc2UpXG5cbiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInKSB7XG4gICAgLy8gcHJvdGVjdCBhZ2FpbnN0IHBvc2l0aXZlIHB4IHZhbHVlcywgZm9yIG5vd1xuICAgIHNldFJvb3RNYXJnaW4gPSBgLSR7TWF0aC5hYnMob2Zmc2V0KX1weCAwJWBcbiAgfSBlbHNlIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnc3RyaW5nJykge1xuICAgIC8vIHByb3RlY3QgYWdhaW5zdCBwb3NpdGl2ZSBwZXJjZW50YWdlIHZhbHVlcywgZm9yIG5vd1xuICAgIHNldFJvb3RNYXJnaW4gPSBgLSR7TWF0aC5hYnMocGFyc2VGbG9hdChvZmZzZXQpKX0lIDAlYFxuICB9XG5cbiAgaWYgKHRvZ2dsZSAmJiBpc09iamVjdCh0b2dnbGUpKSB7XG4gICAgc2V0VG9nZ2xlID0gbmV3IHNldENsYXNzTmFtZSh0b2dnbGUpXG4gIH1cblxuICBpZiAoZ3NhcCAmJiBpc09iamVjdChnc2FwKSkge1xuICAgIHNldEdzYXAgPSBuZXcgc2V0VHdlZW4oZ3NhcClcbiAgfVxuXG4gIGlmICh2aWRlbyAmJiBpc09iamVjdCh2aWRlbykpIHtcbiAgICBzZXRWaWRlbyA9IG5ldyBzZXRQbGF5ZXIodmlkZW8pXG4gIH1cblxuICBpZiAoY2FsbGJhY2spIHtcbiAgICBzZXRDYWxsYmFjayA9IG5ldyBzZXRGdW5jdGlvbihjYWxsYmFjaylcbiAgfVxuXG4gIGNvbnN0IG9ic2VydmVyQ2FsbGJhY2sgPSBmdW5jdGlvbihlbnRyaWVzKSB7XG4gICAgZW50cmllcy5mb3JFYWNoKCh7IGlzSW50ZXJzZWN0aW5nLCBpbnRlcnNlY3Rpb25SYXRpbyB9KSA9PiB7XG4gICAgICAvKlxuICAgICAgICogVG8gaGVscCB0aGUgd29ua2luZXNzIG9mIEludGVyc2VjdGlvbk9ic2VydmVyLCBpc0ludGVyc2VjdGluZyBmaXJpbmcgdHJ1ZSB3aGVuIGl0J3MgcmVhbGx5IGZhbHNlXG4gICAgICAgKi9cbiAgICAgIGlmIChyYXRpbykge1xuICAgICAgICBzZXRTdGF0ZS52aXNpYmxlID0gaW50ZXJzZWN0aW9uUmF0aW8gPj0gcmF0aW9cbiAgICAgIH0gZWxzZSBpZiAoaXNJbnRlcnNlY3RpbmcgJiYgIXNldFN0YXRlLnZpc2libGUpIHtcbiAgICAgICAgLypcbiAgICAgICAgICogVG8gaGVscCB3aXRoIHNldENhbGxiYWNrIGFuZCBpZ25vcmluZyByZWZpcmluZyBleHRyYSBmdW5jdGlvblxuICAgICAgICAgKiBjYWxscyBkdWUgdG8gaW50ZXJzZWN0aW9uUmF0aW9cbiAgICAgICAgICovXG4gICAgICAgIHNldFN0YXRlLnZpc2libGUgPSB0cnVlXG4gICAgICB9IGVsc2UgaWYgKCFpc0ludGVyc2VjdGluZyAmJiBzZXRTdGF0ZS52aXNpYmxlKSB7XG4gICAgICAgIHNldFN0YXRlLnZpc2libGUgPSBmYWxzZVxuICAgICAgfVxuXG4gICAgICBzZXRUb2dnbGUgJiYgc2V0VG9nZ2xlLnVwZGF0ZShzZXRTdGF0ZSlcbiAgICAgIHNldEdzYXAgJiYgKCF1c2VEdXJhdGlvbiA/IHNldEdzYXAudXBkYXRlKHNldFN0YXRlKSA6IHNldEdzYXAuc2NydWIoaW50ZXJzZWN0aW9uUmF0aW8pKVxuICAgICAgc2V0VmlkZW8gJiYgc2V0VmlkZW8udXBkYXRlKHNldFN0YXRlKVxuICAgICAgc2V0Q2FsbGJhY2sgJiYgc2V0Q2FsbGJhY2sudXBkYXRlKHNldFN0YXRlKVxuXG4gICAgICBpZiAoaXNJbnRlcnNlY3RpbmcgJiYgZGVzdHJveUltbWVkaWF0ZWx5KSB7XG4gICAgICAgIC8qXG4gICAgICAgICAqIGRlc3Ryb3kgdGhlIHNjZW5lIGFmdGVyIHVzZWQgb25jZVxuICAgICAgICAgKi9cbiAgICAgICAgJHRoaXMuZGVzdHJveSgpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IGdldFBlcmNlbnRhZ2UgPSB2YWx1ZSA9PiB7XG4gICAgaWYgKCFpc1N0cmluZyh3aGVuVmlzaWJsZSkgJiYgIXN0cmluZ0NvbnRhaW5zKHdoZW5WaXNpYmxlLCAnJScpKSB7XG4gICAgICBlcnJvckxvZyhuYW1lU3BhY2UsICdCZSBzdXJlIHRvIHNldCBhIHBlcmNlbnRhZ2UgYXMgYSBzdHJpbmcuIHsgd2hlblZpc2libGU6IFwiNTAlXCIgfScpXG4gICAgfVxuXG4gICAgY29uc3QgcGFyc2VkID0gcGFyc2VJbnQodmFsdWUucmVwbGFjZSgnJScsICcnKSkgLyAxMDBcblxuICAgIHJhdGlvID0gcGFyc2VkXG5cbiAgICByZXR1cm4gcGFyc2VkXG4gIH1cblxuICBjb25zdCBnZXRUaHJlc29sZHMgPSAoKSA9PiB7XG4gICAgY29uc3QgZGVmYXVsdHMgPSB7XG4gICAgICBvbmU6IFswLCAxXSxcbiAgICAgIGdzYXA6IGNyZWF0ZUFycmF5KDE5OSksXG4gICAgfVxuXG4gICAgbGV0IHJldHVybmVkVGhyZXNob2xkczogYW55ID0gZGVmYXVsdHMub25lXG5cbiAgICBpZiAod2hlblZpc2libGUpIHtcbiAgICAgIHJldHVybmVkVGhyZXNob2xkcyA9IGdldFBlcmNlbnRhZ2Uod2hlblZpc2libGUpXG4gICAgfVxuXG4gICAgaWYgKHVzZUR1cmF0aW9uKSB7XG4gICAgICByZXR1cm5lZFRocmVzaG9sZHMgPSBkZWZhdWx0cy5nc2FwXG4gICAgfVxuXG4gICAgaWYgKHRocmVzaG9sZHMpIHtcbiAgICAgIHJldHVybmVkVGhyZXNob2xkcyA9IGNyZWF0ZUFycmF5KHRocmVzaG9sZHMpXG4gICAgfVxuXG4gICAgcmV0dXJuIHJldHVybmVkVGhyZXNob2xkc1xuICB9XG5cbiAgY29uc3QgT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIob2JzZXJ2ZXJDYWxsYmFjaywge1xuICAgIHRocmVzaG9sZDogZ2V0VGhyZXNvbGRzKCksXG4gICAgcm9vdE1hcmdpbjogc2V0Um9vdE1hcmdpbixcbiAgICAuLi5vYnNlcnZlcixcbiAgfSlcblxuICB0aGlzLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgICBPYnNlcnZlci5vYnNlcnZlKHRyaWdnZXJFbGVtZW50KVxuICB9XG5cbiAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRyaWdnZXJFbGVtZW50ICYmIE9ic2VydmVyKSB7XG4gICAgICBpZiAoc2V0VG9nZ2xlKSB7XG4gICAgICAgIHNldFRvZ2dsZS5yZW1vdmUoKVxuICAgICAgfVxuXG4gICAgICBpZiAoc2V0R3NhcCkge1xuICAgICAgICBzZXRHc2FwLmtpbGwoKVxuICAgICAgfVxuXG4gICAgICBpZiAoc2V0VmlkZW8pIHtcbiAgICAgICAgc2V0VmlkZW8ua2lsbCgpXG4gICAgICB9XG5cbiAgICAgIE9ic2VydmVyLnVub2JzZXJ2ZSh0cmlnZ2VyRWxlbWVudClcbiAgICB9XG4gIH1cblxuICBzY3JvbGxBbmltYXRpb25Jbml0KGJyZWFrcG9pbnRzLCB0aGlzLmluaXQsIHRoaXMuZGVzdHJveSlcbn1cblxuZXhwb3J0IHsgU2Nyb2xsT2JzZXJ2ZXIgfVxuIl19